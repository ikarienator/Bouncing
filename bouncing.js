/**
 * 
 * @param object
 * @param overrides
 */function Vector3(){}function Matrix3(a,b,c,d,e,f){a instanceof Matrix3?this.matrix=[[a.matrix[0][0],a.matrix[0][1],a.matrix[0][2]],[a.matrix[1][0],a.matrix[1][1],a.matrix[1][2]]]:Array.isArray(a)?this.matrix=[[a[0][0],a[0][1],a[0][2]],[a[1][0],a[1][1],a[1][2]]]:typeof a=="number"?this.matrix=[[a,c,e],[b,d,f]]:this.matrix=[[1,0,0],[0,1,0]]}function Attributes(a){this.shadow=Object.chain(this.shadow),this.matrix=new Matrix3,a&&this.apply(a)}function Sprite(a){this.attr=new Attributes(a)}function RectSprite(a){this.x=a.x||0,this.y=a.y||0,this.width=a.width||10,this.height=a.height||10,Sprite.apply(this,[a])}function ImageSprite(a){this.x=a.x||0,this.y=a.y||0,this.radius=a.radius||10,Sprite.apply(this,[a])}function TextSprite(a){this.x=a.x||0,this.y=a.y||0,this.text=a.text||"",this.font=a.font||"Arial",this.size=a.size||10,this.unit=a.unit||"px",Sprite.apply(this,[a])}function Surface(a,b,c){if(!this instanceof Surface)return new Surface(a,b,c);this.sprites={},this.device=Surface.createDevice(a,b,c),this.currentId=1}Object.chain=function(a,b){var c=Object.create(a);if(b)for(var d in b)c[d]=b[d];return c},Object.extend=function(a,b){var c=b.hasOwnProperty("constructor")?b.constructor:function(){a.apply(this,arguments)};c.prototype=new a,delete b.constructor;for(var d in b)c.prototype[d]=b[d];return c};var rad=Math.PI/180,deg=1/rad;Matrix3.prototype={$mult:function(a,b,c,d,e,f){var g=[[],[],[]],h=this.matrix,i=(new Matrix3(a,b,c,d,e,f)).matrix;return g[0][0]=h[0][0]*i[0][0]+h[0][1]*i[1][0],g[1][0]=h[1][0]*i[0][0]+h[1][1]*i[1][0],g[2][0]=h[2][0]*i[0][0]+h[2][1]*i[1][0]+h[0][2],g[0][1]=h[0][0]*i[0][1]+h[0][1]*i[1][1],g[1][1]=h[1][0]*i[0][1]+h[1][1]*i[1][1],g[2][1]=h[2][0]*i[0][1]+h[2][1]*i[1][1]+h[0][2],g[0][2]=h[0][0]*i[0][2]+h[0][1]*i[1][2],g[1][2]=h[1][0]*i[0][2]+h[1][1]*i[1][2],g[2][2]=h[2][0]*i[0][2]+h[2][1]*i[1][2]+h[0][2],g},postpend:function(a){return this.matrix=this.$mult(a),this},prepend:function(a){return this.matrix=a.$mult(this),this},inverse:function(){var a=this.matrix,b=a[0][0],c=a[1][0],d=a[0][1],e=a[1][1],f=a[0][2],g=a[1][2],h=1/(b*e-c*d);return new Matrix3(e*h,-c*h,-d*h,b*h,(d*g-e*f)*h,(c*f-b*g)*h)},translate:function(a,b){return this.prepend(new Matrix3(1,0,0,1,a,b)),this},scale:function(a,b,c,d){var e=this;return b=b||a,c=c||0,d=d||0,e.prepend(new Matrix3(a,0,0,b,c*(1-a),d*(1-b))),e},rotate:function(a,b,c){a*=rad;var d=this,e=Math.cos(a),f=Math.cos(a);return b=b||0,c=c||0,d.prepend(new Matrix3(e,f,-f,e,-e*b+b-f*c,f*b-e*c+c)),d},x:function(a,b){var c=this.matrix[0];return a*c[0]+b*c[1]+c[2]},y:function(a,b){var c=this.matrix[1];return a*c[0]+b*c[1]+c[2]},toCanvas:function(a){var b=this.matrix;a.transform(b[0][0],b[1][0],b[0][1],b[1][1],b[0][2],b[1][2])},toSvg:function(){var a=this.matrix;return"matrix("+[a[0][0],a[1][0],a[0][1],a[1][1],a[0][2],a[1][2]].join(",")+")"}},window.Matrix3=Matrix3,Attributes.prototype={fill:"#000",stroke:"#000",thickness:1,opacity:1,zIndex:0,shadow:{on:!1,color:"#000",dx:5,dy:5,blur:5,opacity:.3},apply:function(a){for(var b in a)if(b==="shadow")for(var c in a.shadow)c in this.shadow&&(this.shadow[c]=a.shadow[c]);else b in this&&(this[b]=a[b])}},Sprite.prototype={connect:function(a){},render:function(){throw"abstract"}},RectSprite.prototype={connect:function(a){this.targetId=a.aquirePath()},update:function(a,b){var c=this,d=b[this.targetId],e=this.attr;d.setAttributes(e),d.setPath(["M",c.x,c.y,"l",c.width,0,"l",0,c.height,"l",-c.width,0,"z"])}},EllipseSprite=Object.extend(Sprite,{constructor:function(a){this.x=a.x||0,this.y=a.y||0,this.width=a.width||10,this.height=a.height||10,Sprite.apply(this,[a])},connect:function(a){this.targetId=a.aquirePath()},update:function(a,b){var c=this,d=b[this.targetId],e=this.attr,f=this.width*.5,g=this.height*.5,h=this.x+f,i=this.y+g,j=.5522847498307935;d.setAttributes(e),debugger,d.setPath(["M",h,i-g,"C",h+j*f,i-g,h+f+i-j*g,h+f,i,"S",h+j*f,i+g,h,i+g,"S",h-f,i+j*g,h-f,i,"S",h-j*f,i-g,h,i-g,"z"])}}),ImageSprite.prototype={connect:function(a){this.targetId=a.aquireCircle()},update:function(a,b){var c=this,d=b[this.targetId],e=this.attr,f=this.radius;d.setAttributes(e),d.setPosition(this.x,this.y),d.setRadius(this.radius)}},TextSprite.prototype={connect:function(a){this.targetId=a.aquireText()},update:function(a,b){var c=this,d=b[this.targetId],e=this.attr;d.setAttributes(e),d.setFont(this.font),d.setSize(this.size),d.setUnit(this.unit),d.setPosition(this.x,this.y),d.setText(this.text)}},function(a){function b(a,b,c){this.currentAquiringContext=null,this.targets={},this.aquiringTargets=null;var d=this.canvas=document.createElement("canvas");a.appendChild(d),d.width=b,d.height=c,d.innerHTML="Fallback content, in case the browser does not support Canvas.",this.ctx=d.getContext("2d")}var c=function(){this.attr=new Attributes};c.prototype.setAttributes=function(a){this.attr.apply(a)};var d=Object.extend(c,{drawPath:function(){throw"abstract"},render:function(a,b){var c=this.attr;a.beginPath(),this.drawPath(a),a.closePath(),a.fill(),b||a.stroke()}}),e=Object.extend(d,{constructor:function(){d.apply(this,arguments),this.path=[]},drawPath:function(a){var b=this.path,c=b.length,d=[0,0],e=d,f,g;for(var h=0;h<c;h++)switch(b[h]){case"M":e=d=[b[++h],b[++h]],a.moveTo(d[0],d[1]);break;case"m":e=d=[d[0]+b[++h],d[1]+b[++h]],a.moveTo(d[0],d[1]);break;case"L":d=[b[++h],b[++h]],a.lineTo(d[0],d[1]);break;case"l":d=[d[0]+b[++h],d[1]+b[++h]],a.lineTo(d[0],d[1]);break;case"C":f=[b[++h],b[++h]],g=[b[++h],b[++h]],d=[b[++h],b[++h]],a.bezierCurveTo(f[0],f[1],g[0],g[1],d[0],d[1]);break;case"c":f=[d[0]+b[++h],d[1]+b[++h]],g=[d[0]+b[++h],d[1]+b[++h]],d=[d[0]+b[++h],d[1]+b[++h]],a.bezierCurveTo(f[0],f[1],g[0],g[1],d[0],d[1]);break;case"S":f=[d[0]*2-f[0],d[1]*2-f[1]],g=[b[++h],b[++h]],d=[b[++h],b[++h]],a.bezierCurveTo(f[0],f[1],g[0],g[1],d[0],d[1]);break;case"Z":case"z":a.closePath()}},setPath:function(a){this.path=a}}),f=Object.extend(d,{setPosition:function(a,b){this.x=a,this.y=b},setRadius:function(a){this.radius=a},drawPath:function(a){a.arc(this.x,this.y,this.radius,0,Math.PI*2,!0)}});b.prototype={strict:!1,setSize:function(a,b){this.canvas.width=a,this.canvas.height=b},startAquiringContext:function(a){this.currentAquiringContext===null&&(this.currentAquiringContext=a,this.aquiringTargets=this.targets[a]=this.targets[a]||[])},stopAquiringContext:function(){this.currentAquiringContext=null,this.aquiringTargets=null},aquirePath:function(){var a=this.aquiringTargets.length;return this.aquiringTargets[this.aquiringTargets.length]=new e,a},aquireCircle:function(){var a=this.aquiringTargets.length;return this.aquiringTargets[this.aquiringTargets.length]=new f,a},getTargets:function(a){return this.targets[a]},renderZStrip:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d.attr,f=e.shadow;a.fillStyle=e.fill,a.strokeStyle=e.stroke,a.lineWidth=e.thickness,f.on&&(a.shadowColor=f.color,a.shadowOffsetX=f.dx,a.shadowOffsetY=f.dy,a.shadowBlur=f.blur,a.globalAlpha=e.opacity*f.opacity,d.render(a,!0),a.shadowColor="none",a.globalAlpha=(1-f.opacity)/(1-f.opacity*e.opacity)*e.opacity),d.render(a,!1)}},renderZStripStrict:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d.attr,f=e.shadow;f.on&&(a.shadowColor=f.color,a.shadowOffsetX=f.dx,a.shadowOffsetY=f.dy,a.shadowBlur=f.blur,a.fillStyle=e.fill,a.globalAlpha=e.opacity*f.opacity,d.render(a,!0))}a.shadowColor="none";for(var c=0;c<b.length;c++){var d=b[c],e=d.attr;a.fillStyle=e.fill,a.strokeStyle=e.stroke,a.lineWidth=e.thickness,f.on?a.globalAlpha=(1-f.opacity)/(1-f.opacity*e.opacity)*e.opacity:a.globalAlpha=e.opacity,d.render(a,!1)}},render:function(){var a=this.targets,b={},c,d=this.ctx,e=this.strict?this.renderZStripStrict:this.renderZStrip;for(var f in a){var g=this.targets[f];for(var h=0;h<g.length;h++){var i=g[h],j=+i.attr.zIndex;b[j]||(b[j]=[]),b[j].push(i)}}c=Object.keys(b).sort(),d.lineJoin="miter";for(var k=0;k<c.length;k++){var l=c[k];d.save();var m=b[l];e(d,m),d.restore()}}},a.Canvas=b}(this),Surface.prototype={setSize:function(a,b){this.device.setSize(a,b)},add:function(a,b){!b&&typeof a!="string"&&(b=a,a=b.type);var c=this["create"+a[0].toUpperCase()+a.substr(1).toLowerCase()](b);c.id="sprite-"+this.currentId++,this.sprites[c.id]=c,this.device.startAquiringContext(c.id),c.connect(this.device),this.device.stopAquiringContext()},get:function(a){return typeof a=="string"?this.sprites[a]:a instanceof Sprite?a:undefined},remote:function(a){typeof a=="string"&&(a=this.sprites[a]),a&&(a.destroy(),delete this.sprites[a.id])},createText:function(a){return new TextSprite(a)},createRect:function(a){return new RectSprite(a)},createEllipse:function(a){return new EllipseSprite(a)},createPath:function(a){return new PathSprite(a)},createImage:function(a){return new ImageSprite(a)},render:function(){var a=this.sprites;for(var b in a)this.updateSprite(a[b]);this.device.render()},updateSprite:function(a){a.update(this.device,this.device.getTargets(a.id))},destroy:function(){}},Surface.createDevice=function(a,b,c){return new Canvas(a,b,c)};